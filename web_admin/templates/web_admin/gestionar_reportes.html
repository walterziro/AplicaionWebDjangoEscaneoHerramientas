{% extends "base.html" %} 

{% block content %}
<div class="container mt-5">
    
    <div class="p-4 mb-4 bg-info text-white rounded-3">
        <h2>{{ titulo }}</h2>
        <p class="lead">Administrador: <strong>{{ admin_data.nombre }}</strong></p>
    </div>

    <div class="text-start mb-4">
        <a href="{% url 'web_admin:dashboard' %}" class="btn btn-outline-secondary">
             Volver al Menú de Gestión
        </a>
    </div>

    <h3>Reportes de Usuario (Totales: {{ stats.reportes_totales }} | Pendientes: {{ stats.reportes_pendientes }})</h3>
    <p class="text-muted">Utiliza los filtros para encontrar reportes de mayor valor.</p>
    
    {% if alerta_error %}
        <div class="alert alert-warning" role="alert">
            {{ alerta_error }}
        </div>
    {% elif alerta_info %}
        <div class="alert alert-info" role="alert">
            {{ alerta_info }}
        </div>
    {% elif alerta_exito %}
        <div class="alert alert-success" role="alert">
            {{ alerta_exito }}
        </div>
    {% endif %}

    {% if descarga_doble_activa %}
    <div class="card border-success mb-4 shadow-sm">
        <div class="card-header bg-success text-white fw-bold">
             Archivos Listos para Descarga
        </div>
        <div class="card-body">
            <p>Haga clic en cada botón para iniciar la descarga del archivo correspondiente. (Requiere dos clics manuales):</p>
            <div class="d-flex justify-content-center flex-wrap gap-3">
                
                {% if csv_download_url %}
                <a href="{{ csv_download_url }}" class="btn btn-primary btn-lg" target="_blank" 
                   onclick="this.disabled=true; this.textContent='CSV Descargado'; this.classList.replace('btn-primary', 'btn-secondary');">
                    <i class="fas fa-file-csv me-2"></i> Descargar CSV ({{ csv_filename|default:'reporte.csv' }})
                </a>
                {% endif %}
                
                {% if pdf_download_url %}
                <a href="{{ pdf_download_url }}" class="btn btn-danger btn-lg" target="_blank" 
                   onclick="this.disabled=true; this.textContent='PDF Descargado'; this.classList.replace('btn-danger', 'btn-secondary');">
                    <i class="fas fa-file-pdf me-2"></i> Descargar PDF ({{ pdf_filename|default:'reporte.pdf' }})
                </a>
                {% endif %}
            </div>
            
            <div class="mt-4 text-center">
                <a href="{% url 'web_admin:gestionar_reportes' %}" class="btn btn-outline-secondary btn-sm">
                     Finalizar y Recargar (Ver estados actualizados)
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    <form method="GET" class="card card-body mb-4 shadow-sm" style="background-color: #f8f9fa;">
        <div class="row align-items-end">
            {% for field in filter_form %}
                <div class="col-md-3 col-sm-6 mb-2">
                    <label for="{{ field.id_for_label }}" class="form-label small fw-bold mb-0">{{ field.label }}</label>
                    {{ field }}
                </div>
            {% endfor %}
            <div class="col-md-3 col-sm-6 mb-2 d-flex">
                <button type="submit" class="btn btn-primary w-50 me-2 btn-sm">Buscar</button>
                <a href="{% url 'web_admin:gestionar_reportes' %}" class="btn btn-outline-secondary w-50 btn-sm">Limpiar</a>
            </div>
        </div>
    </form>

    <form id="report-selection-form" method="POST" action="{% url 'web_admin:gestionar_reportes' %}" onsubmit="return handleFormSubmit(event)">
        {% csrf_token %}
        <div class="row mb-4">
            <div class="col">
                <div class="card shadow">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        Reportes Filtrados ({{ reportes_filtrados|length }})
                        
                        <div class="d-flex align-items-center">
                            <label for="{{ generacion_form.formato.id_for_label }}" class="form-label small fw-bold mb-0 me-2">Formato:</label>
                            {{ generacion_form.formato }} 
                            <button type="submit" class="btn btn-sm btn-info ms-3">
                                 Generar y Descargar Informe
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 5%;"><input type="checkbox" id="select-all"></th>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Tipo</th>
                                    <th>Herramienta</th>
                                    <th>Usuario UID</th>
                                    <th>Descripción</th>
                                    <th>Asignado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reporte in reportes_filtrados %}
                                <tr>
                                    <td><input type="checkbox" name="reporte_id" value="{{ reporte.id }}"></td>
                                    <td>{{ reporte.id }}</td>
                                    <td>{{ reporte.fecha_reporte|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if reporte.estado == 'pendiente' %}
                                            <span class="badge bg-warning text-dark">{{ reporte.estado|capfirst }}</span>
                                        {% elif reporte.estado == 'revisado' %}
                                            <span class="badge bg-success">{{ reporte.estado|capfirst }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ reporte.estado|capfirst }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ reporte.tipo }}</td>
                                    <td>{{ reporte.herramienta.nombre|default:"N/A" }}</td>
                                    <td>{{ reporte.usuario.uid }}</td>
                                    <td>{{ reporte.descripcion|truncatechars:50 }}</td>
                                    <td>{{ reporte.administrador.nombre|default:"Sin Asignar" }}</td>
                                </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">No se encontraron reportes.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="mt-5 text-center">
        <a href="{% url 'web_admin:dashboard' %}" class="btn btn-outline-secondary me-3">Volver al Menú</a>
        <form action="{% url 'admin:logout' %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Cerrar Sesión</button>
        </form>
    </div>

</div>

<script>
    // Seleccionar/Deseleccionar todos
    document.getElementById('select-all').onclick = function() {
        var checkboxes = document.getElementsByName('reporte_id');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    }

    // Validar selección y manejar descarga
    function handleFormSubmit(event) {
        var checkboxes = document.getElementsByName('reporte_id');
        var isChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);

        if (!isChecked) {
            alert('ERR-REP-002: No se seleccionaron datos. Debes seleccionar al menos un reporte para generar el informe.');
            event.preventDefault(); 
            return false;
        }
        
        // ❌ Importante: Se elimina el viejo setTimeout para evitar la recarga forzada.
        // Ahora la recarga la maneja el servidor con un redirect si es 'ambos' 
        // o queda a cargo del usuario si es CSV/PDF individual.

        return true; 
    }
</script>
{% endblock %}